---
layout: default
---

{% comment %} navbar removed on post pages {% endcomment %}

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting" id="main" role="article" aria-label="Content">

  <div class="post-logo-left">
    <a href="{{ '/' | relative_url }}">
      <img src="{{ '/assets/images/carruc-eu-logo-inline.png' | relative_url }}" alt="carruc.eu logo inline">
    </a>
  </div>

  <aside class="post-toc-left">
    <nav class="toc" aria-label="Table of contents">
      <div class="toc-title">Table of Contents:</div>
      <ul class="toc-list"></ul>
    </nav>
  </aside>

  <!-- This is the container for sidenotes, placed in the third grid column -->
  <div class="post-side-right" id="sidenotes-container">
    <!-- Sidenotes will be dynamically injected here -->
  </div>

  <nav class="menu">
    <ul>
      {% for item in site.data.menu %}
          <a href="{{ item.url | relative_url }}">{{ item.title }}</a>
      {% endfor %}
    </ul>
  </nav>

  {% if page.title != "" %}
    <h1 class="post-title p-name" itemprop="name headline">
      {{ page.title }}
    </h1>
  {% endif %}

  <div class="article-body-container">
    {% if page.intro %}
      <p class="intro">{{ page.intro }}</p>
    {% endif %}

    <div class="post-content e-content" itemprop="articleBody">
      {{ content }}
    </div>

    {% if page.bibliography %}
      <section class="bibliography">
        <h3 class="bibliography-title">Bibliography</h3>
        <ul class="bibliography-list">
          {% for item in page.bibliography %}
            <li><a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.name }}</a></li>
          {% endfor %}
        </ul>
      </section>
    {% endif %}
  </div>

  <div class="post-meta">
    {% if page.author %}
      <div itemprop="author">{{ page.author }}</div>
    {% endif %}
    <time class="post-date dt-published" datetime="{{ page.date | date_to_xmlschema }}" itemprop="datePublished">{{ page.date | date: "%B %-d, %Y" }}</time>
  </div>

  {% if site.disqus.shortname %}
    {% include disqus-comments.html %}
  {% endif %}

</article>

<!-- Combined Scripts for TOC, Sidenotes, and Image Captions -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 1. Table of Contents Generator
    (function() {
      var content = document.querySelector('.post .article-body-container .post-content');
      var list = document.querySelector('.post .post-toc-left .toc-list');
      if (!content || !list) return;
      var headings = content.querySelectorAll('h1, h2, h3');
      if (!headings.length) return;

      function slugify(text) {
        return text.toLowerCase().trim().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
      }

      headings.forEach(function(h) {
        var level = parseInt(h.tagName.substr(1), 10);
        if (level < 1 || level > 3) return;
        if (!h.id) {
          h.id = slugify(h.textContent || h.innerText || 'section');
        }
        var li = document.createElement('li');
        li.className = 'toc-level-' + level;
        var a = document.createElement('a');
        a.href = '#' + h.id;
        a.textContent = h.textContent || h.innerText || '';
        li.appendChild(a);
        list.appendChild(li);
      });
    })();

    // 2. Image Caption Generator
    (function() {
        const images = document.querySelectorAll('.post-content img');
        images.forEach(img => {
            const altText = img.alt;
            if (!altText.trim()) return;

            const figure = document.createElement('figure');
            const figcaption = document.createElement('figcaption');
            figcaption.textContent = altText;
            
            img.parentNode.insertBefore(figure, img);
            figure.appendChild(img);
            figure.appendChild(figcaption);
        });
    })();

    // 3. Sidenote Repositioning Logic
    (function() {
      const sidenotesContainer = document.getElementById('sidenotes-container');
      const articleBody = document.querySelector('.article-body-container');
      if (!sidenotesContainer || !articleBody) return;

      // Move footnote content into sidenote elements
      document.querySelectorAll('.footnotes li').forEach(footnote => {
        const noteId = footnote.id; // e.g., "fn:1"
        const backRefLink = footnote.querySelector('a[href^="#fnref"]');
        if (!noteId || !backRefLink) return;

        // *** INTEGRATED LOGIC: Get number from the original reference link in the text ***
        const refLinkInText = document.querySelector(`a[href="#${noteId}"]`);
        const footnoteNumber = refLinkInText ? refLinkInText.textContent : '';
        const numberText = `${footnoteNumber}. `;

        // Remove the back-arrow link
        backRefLink.remove();

        // *** INTEGRATED LOGIC: Prepend the number, handling <p> tags correctly ***
        const firstParagraph = footnote.querySelector('p');
        if (firstParagraph) {
          firstParagraph.innerHTML = numberText + firstParagraph.innerHTML;
        } else {
          footnote.innerHTML = numberText + footnote.innerHTML;
        }

        const backRefId = backRefLink.getAttribute('href').substring(1);
        const newSidenote = document.createElement('aside');
        newSidenote.id = `sidenote-${noteId}`;
        newSidenote.className = 'sidenote';
        newSidenote.dataset.ref = backRefId;
        newSidenote.innerHTML = footnote.innerHTML; // Use the modified, numbered HTML
        
        sidenotesContainer.appendChild(newSidenote);
      });

      // Hide the original footnote list
      const originalFootnotes = document.querySelector('.footnotes');
      if (originalFootnotes) {
        originalFootnotes.style.display = 'none';
      }

      // Position sidenotes and prevent overlap
      function positionSidenotes() {
        let lastSidenoteBottom = 0;
        const sidenoteMargin = 20; // Vertical margin between stacked sidenotes (in pixels)

        document.querySelectorAll('sup[id^="fnref"]').forEach(ref => {
          const refId = ref.id;
          const sidenote = document.querySelector(`.sidenote[data-ref="${refId}"]`);

          if (sidenote) {
            const refTop = ref.offsetTop;
            let newTop = refTop;

            if (newTop < lastSidenoteBottom) {
              newTop = lastSidenoteBottom;
            }

            sidenote.style.top = `${newTop}px`;
            lastSidenoteBottom = newTop + sidenote.offsetHeight + sidenoteMargin;
          }
        });
      }

      positionSidenotes();
      window.addEventListener('resize', positionSidenotes);
    })();
  });
</script>